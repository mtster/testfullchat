<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>App Debug — Protocol Chat</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:0; background:#0b0f14; color:#e6eef8; }
    header { padding:12px; background:#071022; border-bottom:1px solid rgba(255,255,255,0.03); }
    h1 { margin:0; font-size:16px; font-weight:600; }
    .main { display:flex; gap:12px; padding:12px; }
    .left { flex:1; min-width:320px; }
    .panel { background:#0f1720; border:1px solid rgba(255,255,255,0.03); padding:12px; border-radius:8px; margin-bottom:12px; }
    pre { white-space:pre-wrap; word-break:break-word; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px; font-size:13px; }
    iframe { width:100%; height:640px; border:1px solid rgba(255,255,255,0.04); border-radius:8px; display:block; background:white; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .pill { background:rgba(255,255,255,0.03); padding:6px 8px; border-radius:999px; font-size:13px; }
    .ok { color:#7fe0a8; }
    .bad { color:#ff8b8b; }
    .muted { color:#9fb0c3; font-size:13px; }
    button { background:#0b84ff; color:white; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
    small { color:#9fb0c3; }
  </style>
</head>
<body>
  <header>
    <h1>Protocol Chat — Diagnostic page</h1>
    <small>Use this to capture runtime errors, service worker and FCM status from the app iframe.</small>
  </header>

  <div class="main">
    <div class="left">
      <div class="panel">
        <div class="row">
          <div class="pill">App iframe</div>
          <div class="muted">The app will load below — interact with it on your phone as usual (login, open chat).</div>
        </div>

        <iframe id="appFrame" src="./" title="App iframe"></iframe>
        <div style="margin-top:8px;">
          <button id="refreshFrame">Reload frame</button>
          <button id="clearLocal">Clear app localStorage in frame</button>
        </div>
      </div>

      <div class="panel">
        <div class="row"><div class="pill">Captured errors</div></div>
        <div id="errors"><pre>(no errors yet)</pre></div>
      </div>

      <div class="panel">
        <div class="row"><div class="pill">Unhandled Rejections</div></div>
        <div id="rejections"><pre>(no rejections yet)</pre></div>
      </div>

      <div class="panel">
        <div class="row"><div class="pill">Service worker check</div></div>
        <div id="swcheck"><pre>checking...</pre></div>
      </div>

      <div class="panel">
        <div class="row"><div class="pill">Notifications & FCM</div></div>
        <div id="notifinfo"><pre>waiting for app frame...</pre></div>
      </div>
    </div>

    <div style="width:360px;">
      <div class="panel">
        <div class="row"><div class="pill">Quick instructions</div></div>
        <ol style="padding-left:16px; margin:0;">
          <li>Open this page in Safari on your iPhone.</li>
          <li>Use the iframe app to <b>login</b> (same as you normally do).</li>
          <li>Perform the actions: create/open chat, send message — any errors will appear here.</li>
          <li>Copy the text contents of the <b>Captured errors</b> and <b>Unhandled Rejections</b> panels and paste them back to me.</li>
        </ol>
      </div>

      <div class="panel">
        <div class="row"><div class="pill">Hints</div></div>
        <div class="muted">
          If Notifications permission doesn't show up: open the app in regular Safari (not Home Screen), grant permission there, then re-add to Home Screen. If you previously denied, go to Settings → Safari → Advanced → Website Data → search and remove site data for <code>mtster.github.io</code>.
        </div>
      </div>

      <div class="panel">
        <div class="row"><div class="pill">Share results</div></div>
        <div class="muted">
          After you get results, copy the <b>errors</b>, <b>rejections</b>, the <b>Service worker check</b> output, and the <b>Notifications & FCM</b> output and paste them in your reply. I will parse them and give direct file edits.
        </div>
        <div style="margin-top:8px;"><small>Created to avoid needing desktop devtools.</small></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const iframe = document.getElementById('appFrame');
      const errorsEl = document.getElementById('errors');
      const rejEl = document.getElementById('rejections');
      const swEl = document.getElementById('swcheck');
      const notifEl = document.getElementById('notifinfo');
      const refreshBtn = document.getElementById('refreshFrame');
      const clearLocalBtn = document.getElementById('clearLocal');

      function appendPre(el, text) {
        el.innerHTML = '<pre>' + (text || '') + '</pre>';
      }

      function addLine(el, text) {
        const p = document.createElement('pre');
        p.textContent = text;
        el.appendChild(p);
      }

      // When iframe loads, attach event listeners to its window (same origin)
      iframe.addEventListener('load', () => {
        try {
          const w = iframe.contentWindow;
          // clear previous displays
          appendPre(errorsEl, '(no errors yet)');
          appendPre(rejEl, '(no rejections yet)');

          // capture synchronous errors from iframe
          w.addEventListener('error', (ev) => {
            const msg = [
              'Message: ' + (ev && ev.message),
              'Source: ' + (ev && ev.filename) + ':' + (ev && ev.lineno) + ':' + (ev && ev.colno),
              'Error object: ' + (ev && ev.error && ev.error.stack ? ev.error.stack : JSON.stringify(ev.error || 'no stack'))
            ].join('\\n');
            appendPre(errorsEl, msg);
          });

          // capture unhandled promise rejections in iframe
          w.addEventListener('unhandledrejection', (ev) => {
            let reason = ev && ev.reason;
            let text = 'UnhandledRejection: ';
            if (!reason) text += '(no reason)';
            else if (reason.stack) text += reason.stack;
            else if (typeof reason === 'object') text += JSON.stringify(reason);
            else text += String(reason);
            appendPre(rejEl, text);
          });

          // frequently update notification permission and localStorage user and DB check
          const basePath = (function(){
            // compute base path (like /testfullchat)
            const p = window.location.pathname.replace(/\\/debug.html$/, '');
            return p === '' ? '' : p.replace(/\\/$/, '');
          })();
          const swUrl = window.location.origin + basePath + '/firebase-messaging-sw.js';
          const dbOrigin = 'https://protocol-chat-b6120-default-rtdb.europe-west1.firebasedatabase.app';

          // check SW reachable
          (async function checkSW(){
            try {
              const r = await fetch(swUrl, { method:'GET', cache:'no-cache' });
              appendPre(swEl, 'fetch ' + swUrl + ' -> status: ' + r.status + '\\ncontent-type: ' + (r.headers.get('content-type') || 'n/a'));
            } catch (err) {
              appendPre(swEl, 'fetch failed: ' + (err && err.message));
            }
          })();

          // Poll status every 2s for live updates
          const poll = setInterval(async () => {
            try {
              // Notification.permission inside iframe
              let perm = 'n/a';
              try { perm = w.Notification && w.Notification.permission ? w.Notification.permission : 'n/a'; } catch(e){ perm = 'error'; }
              // localStorage user
              let user = null;
              try {
                const raw = w.localStorage.getItem('user');
                user = raw ? JSON.parse(raw) : null;
              } catch(e) {
                user = null;
              }
              let userLine = 'localStorage.user: ' + (user ? JSON.stringify(user) : '(null)');

              // if we have user.id then check fcmTokens for that uid
              let tokenLine = 'fcmTokens check: unknown';
              if (user && user.id) {
                try {
                  const tokenUrl = dbOrigin + '/fcmTokens/' + encodeURIComponent(user.id) + '.json';
                  const r = await fetch(tokenUrl, {cache:'no-cache'});
                  if (r.ok) {
                    const j = await r.json();
                    tokenLine = 'fcmTokens/' + user.id + ': ' + (j ? JSON.stringify(j) : '(no tokens)');
                  } else {
                    tokenLine = 'fcmTokens fetch status ' + r.status;
                  }
                } catch (err) {
                  tokenLine = 'fcmTokens fetch failed: ' + (err && err.message);
                }
              } else {
                tokenLine = 'no logged user found in localStorage';
              }

              appendPre(notifEl, 'Notification.permission (in iframe): ' + perm + '\\n' + userLine + '\\n' + tokenLine);
            } catch (err) {
              appendPre(notifEl, 'polling error: ' + (err && err.message));
            }
          }, 2000);

          // store poll so we might cancel later (not strictly necessary)
          iframe._poller = poll;

        } catch (err) {
          appendPre(errorsEl, 'iframe attach error: ' + (err && err.message));
        }
      });

      // buttons
      refreshBtn.addEventListener('click', () => {
        try {
          if (iframe._poller) clearInterval(iframe._poller);
        } catch (_) {}
        iframe.contentWindow.location.reload();
      });

      clearLocalBtn.addEventListener('click', () => {
        try {
          const w = iframe.contentWindow;
          w.localStorage.clear();
          appendPre(notifEl, 'Cleared iframe localStorage. Reload iframe and login again.');
        } catch (err) {
          appendPre(errorsEl, 'clearLocal error: ' + (err && err.message));
        }
      });

      // initial UI text
      appendPre(errorsEl, "(no errors yet)");
      appendPre(rejEl, "(no rejections yet)");
      appendPre(swEl, "waiting for iframe load...");
      appendPre(notifEl, "waiting for iframe load...");
    })();
  </script>
</body>
</html>
