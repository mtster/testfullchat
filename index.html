<!doctype html><html lang="en"><head>
  
  <base href="/testfullchat/">

  <meta charset="utf-8"/><link rel="manifest" href="/testfullchat/manifest.json?v=3"/><meta name="theme-color" content="#0f1720"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-title" content="Protocol"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/><meta name="description" content="Protocol — a lightweight private chat"/><link rel="icon" type="image/png" sizes="192x192" href="/testfullchat/icons/icon-192.png"/><link rel="icon" type="image/png" sizes="512x512" href="/testfullchat/icons/icon-512.png"/><link rel="apple-touch-icon" href="/testfullchat/icons/icon-192.png"/><link rel="apple-touch-icon" sizes="180x180" href="/testfullchat/icons/icon-192.png"/><link rel="apple-touch-icon" sizes="512x512" href="/testfullchat/icons/icon-512.png"/><title>Protocol</title><script defer="defer" src="/testfullchat/static/js/main.c35cfae4.js"></script><link href="/testfullchat/static/css/main.b3ff2579.css" rel="stylesheet"></head><body>

    <!-- BEGIN TEMPORARY DIAGNOSTIC OVERLAY (REPLACE PREVIOUS ONE) -->
<style id="diag-style">
  #diagOverlay{position:fixed;left:8px;right:8px;top:8px;z-index:999999;background:#071022cc;color:#e6eef8;border-radius:12px;padding:10px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;font-size:13px;box-shadow:0 6px 30px rgba(0,0,0,0.6);max-height:70vh;overflow:auto}
  #diagOverlay h3{margin:0 0 6px 0;font-size:14px}
  #diagOverlay pre{white-space:pre-wrap;max-height:220px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin:6px 0}
  #diagOverlay .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  #diagToggle{position:fixed;right:12px;bottom:12px;z-index:9999999;background:#0b84ff;color:#fff;border:none;padding:10px 12px;border-radius:999px;font-weight:600}
  #diagOverlay a{color:#8fd7ff}
  #diagOverlay button{background:#0b84ff;color:white;border:none;padding:6px 8px;border-radius:6px}
  #diag-log {background:#05121a;padding:8px;border-radius:8px;max-height:220px;overflow:auto;font-size:12px}
</style>

<div id="diagOverlay" role="status" aria-live="polite">
  <h3>Runtime diagnostics (temporary) — verbose</h3>
  <div class="row"><strong>Notification.permission:</strong> <span id="diag-notif">…</span></div>
  <div class="row"><strong>localStorage.user:</strong> <span id="diag-user">…</span></div>
  <div class="row"><strong>SW status:</strong> <span id="diag-sw">…</span></div>
  <div class="row" style="margin-top:6px">
    <button id="diag-refresh">Reload page</button>
    <button id="diag-clear-ls">Clear localStorage</button>
    <button id="diag-get-scripts">Check script assets</button>
    <button id="diag-copy-log">Copy last log</button>
  </div>

  <div style="margin-top:10px">
    <div><strong>Captured console.error</strong></div>
    <pre id="diag-consoles">(none)</pre>
  </div>

  <div style="margin-top:8px">
    <div><strong>Unhandled rejections (latest first)</strong></div>
    <pre id="diag-rejections">(none yet)</pre>
  </div>

  <div style="margin-top:8px">
    <div><strong>Errors (window.onerror)</strong></div>
    <pre id="diag-errors">(none yet)</pre>
  </div>

  <div style="margin-top:8px">
    <div><strong>Scripts found & fetch status</strong></div>
    <pre id="diag-scripts">(not checked)</pre>
  </div>

  <div style="margin-top:8px">
    <div><strong>Notes</strong></div>
    <div style="color:#9fb0c3;font-size:12px">Reproduce the problem (login / open chat). Then copy the contents of <em>Unhandled rejections</em>, <em>Errors</em>, <em>Console</em> and <em>Scripts</em> and paste them here so I can analyze the real error object.</div>
  </div>
</div>
<button id="diagToggle" aria-label="Toggle diagnostics">Diag</button>

<script>
(function(){
  function $(id){return document.getElementById(id);}
  const rejectionsEl = $('diag-rejections');
  const errorsEl = $('diag-errors');
  const scriptsEl = $('diag-scripts');
  const consolesEl = $('diag-consoles');
  const notifSpan = $('diag-notif');
  const userSpan = $('diag-user');
  const swSpan = $('diag-sw');
  const overlay = $('diagOverlay');
  const toggle = $('diagToggle');

  // toggle
  toggle.addEventListener('click', () => {
    overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
  });

  // friendly stringify with cycle support
  function safeStringify(obj, n=2) {
    const seen = new WeakSet();
    try {
      return JSON.stringify(obj, function(key, val) {
        if (val && typeof val === 'object') {
          if (seen.has(val)) return '[Circular]';
          seen.add(val);
        }
        if (typeof val === 'function') return '[Function]';
        return val;
      }, n);
    } catch (e) {
      try { return String(obj); } catch (e2) { return '[unserializable]'; }
    }
  }

  function prepend(el, text) {
    el.textContent = new Date().toLocaleTimeString() + ' — ' + text + '\\n\\n' + el.textContent;
  }

  // capture console.error
  (function(){
    const orig = console.error;
    console.error = function(...args){
      try {
        const text = args.map(a => {
          if (a && a.stack) return a.stack;
          try { return safeStringify(a); } catch (e) { return String(a); }
        }).join(' ');
        prepend(consolesEl, text);
      } catch (e) {}
      try { orig.apply(console, args); } catch(e){}
    };
  })();

  // window.onerror
  window.addEventListener('error', function(ev){
    const msg = (ev && ev.message) ? ev.message : safeStringify(ev);
    const extra = 'source: ' + (ev.filename || '') + ':' + (ev.lineno||'') + ':' + (ev.colno||'');
    prepend(errorsEl, msg + '\\n' + extra + (ev.error && ev.error.stack ? '\\nStack:\\n' + ev.error.stack : ''));
  });

  // unhandledrejection - capture detailed reason (object, error, string, etc.)
  window.addEventListener('unhandledrejection', function(ev){
    let reason = ev && ev.reason;
    let out = '';
    if (!reason) {
      out = 'UnhandledRejection (no reason)';
    } else if (reason instanceof Error) {
      out = 'Error: ' + (reason.message || '') + '\\nStack:\\n' + (reason.stack || '(no stack)');
    } else {
      // attempt to stringify
      out = 'Reason object: ' + safeStringify(reason, 2);
    }
    prepend(rejectionsEl, out);
    // also log to console for persistence
    try { console.error('Captured unhandledrejection:', reason); } catch(e){}
  });

  // basic status update
  function updateBasic() {
    try { notifSpan.textContent = (window.Notification && window.Notification.permission) ? window.Notification.permission : 'n/a'; } catch(e){ notifSpan.textContent = 'err'; }
    try { const raw = localStorage.getItem('user'); userSpan.textContent = raw ? raw : '(null)'; } catch(e){ userSpan.textContent = 'err'; }
    try {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
          if (reg) swSpan.textContent = 'registered (scope: ' + (reg.scope || '') + ')';
          else swSpan.textContent = 'no registration';
        }).catch(() => { swSpan.textContent = 'getRegistration error'; });
      } else swSpan.textContent = 'SW not supported';
    } catch(e) { swSpan.textContent = 'err'; }
  }
  updateBasic();
  setInterval(updateBasic, 2000);

  // script check (same as before)
  $('diag-get-scripts').addEventListener('click', async function(){
    scriptsEl.textContent = 'Checking scripts...';
    try {
      const scripts = Array.from(document.getElementsByTagName('script')).map(s => s.src || '(inline)');
      let out = '';
      for (const s of scripts) {
        out += 'SCRIPT: ' + s + '\\n';
        if (!s || s === '(inline)') { out += '  (inline script)\\n\\n'; continue; }
        try {
          const url = new URL(s, location.href).href;
          const r = await fetch(url, {cache:'no-cache'});
          out += '  fetch status: ' + r.status + ' content-type: ' + (r.headers.get('content-type') || 'n/a') + '\\n';
          try { const txt = await r.text(); out += '  snippet: ' + txt.slice(0,160).replace(/\\n/g,' ') + '\\n'; } catch(e){}
        } catch(fetchErr) {
          out += '  fetch failed: ' + (fetchErr && fetchErr.message) + '\\n';
        }
        out += '\\n';
      }
      scriptsEl.textContent = out;
    } catch(e) { scriptsEl.textContent = 'script check failed: ' + (e && e.message); }
  });

  // copy last log
  $('diag-copy-log').addEventListener('click', function(){
    const text = 'REJECTIONS:\\n' + rejectionsEl.textContent + '\\n\\nERRORS:\\n' + errorsEl.textContent + '\\n\\nCONSOLES:\\n' + consolesEl.textContent + '\\n\\nSCRIPTS:\\n' + scriptsEl.textContent;
    try { navigator.clipboard.writeText(text).then(()=>{alert('Logs copied to clipboard');}); } catch(e) { alert('Copy failed: ' + (e && e.message)); }
  });

  // buttons
  $('diag-refresh').addEventListener('click', function(){ location.reload(); });
  $('diag-clear-ls').addEventListener('click', function(){ try { localStorage.clear(); prepend(errorsEl,'Cleared localStorage'); } catch(e){ prepend(errorsEl,'clear localStorage failed'); } });

  // show by default
  overlay.style.display = 'block';
})();
</script>
<!-- END TEMPORARY DIAGNOSTIC OVERLAY (REPLACE PREVIOUS ONE) -->

    
    <noscript>You need to enable JavaScript to run this app.</noscript><div id="root"></div></body></html>
